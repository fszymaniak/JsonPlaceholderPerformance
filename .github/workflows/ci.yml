name: CI Pipeline

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true  # Don't fail pipeline if external API is down

    steps:
      - name: Check JSONPlaceholder API availability
        continue-on-error: true  # Report status but don't block pipeline
        run: |
          echo "Checking JSONPlaceholder API health..."
          echo "Note: This is an external API health check. Failures here indicate the third-party service is experiencing issues."
          echo ""

          # Function to check API with retry logic
          check_api() {
            local max_attempts=3
            local timeout=10
            local attempt=1
            local last_response=""
            local last_exit=0

            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..."

              # Check if the API is reachable with timeout
              set +e
              response=$(curl -s -o /dev/null -w "%{http_code}" --max-time $timeout https://jsonplaceholder.typicode.com/posts 2>&1)
              curl_exit=$?
              set -e

              last_response="$response"
              last_exit=$curl_exit

              echo "  curl exit code: $curl_exit, HTTP status: '$response'"

              # Check if curl command succeeded
              if [ $curl_exit -ne 0 ]; then
                echo "  ⚠ Network error (curl exit code $curl_exit)"
                if [ $attempt -lt $max_attempts ]; then
                  echo "  Retrying in 2 seconds..."
                  sleep 2
                fi
              elif [ "$response" = "200" ]; then
                echo "  ✓ API is healthy (HTTP $response)"
                return 0
              else
                echo "  ⚠ API returned HTTP $response (server error)"
                if [ $attempt -lt $max_attempts ]; then
                  echo "  Retrying in 2 seconds..."
                  sleep 2
                fi
              fi

              attempt=$((attempt + 1))
            done

            echo ""
            echo "⚠ WARNING: JSONPlaceholder API is currently unavailable or unhealthy"
            echo "  Last HTTP status: $last_response"
            echo "  Last curl exit code: $last_exit"
            echo ""
            echo "This is an external dependency issue and does not indicate a problem with your code."
            return 1
          }

          # Run the health check with retries
          if check_api; then
            echo ""
            echo "✓ Health check passed - API is available and healthy"

            # Additional checks only if API is healthy
            echo ""
            echo "Checking API response time..."
            time_total=$(curl -s -o /dev/null -w "%{time_total}" --max-time 10 https://jsonplaceholder.typicode.com/posts 2>&1)
            echo "✓ API response time: ${time_total}s"

            echo ""
            echo "Verifying API returns valid data..."
            data=$(curl -s --max-time 10 https://jsonplaceholder.typicode.com/posts/1 2>&1)

            if echo "$data" | grep -q "userId"; then
              echo "✓ API returns valid JSON data"
            else
              echo "⚠ API did not return expected data structure"
              echo "Response: $data"
            fi
          else
            echo "⚠ Health check completed with warnings - proceeding anyway"
          fi

          echo ""
          echo "Health check step finished (non-blocking)"

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: health-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run smoke test
        run: k6 run dist/smoke-test.js

      - name: Run load test
        run: k6 run dist/jsonplaceholder-load-test.js

      - name: Run stress test
        run: k6 run dist/stress-test.js
        continue-on-error: true

      - name: Run spike test
        run: k6 run dist/spike-test.js
        continue-on-error: true

      - name: Run soak test
        run: k6 run dist/soak-test.js
        continue-on-error: true

      - name: Performance test summary
        if: always()
        run: |
          echo "Performance testing completed!"
          echo "Check the logs above for detailed results."
